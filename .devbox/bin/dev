#!/usr/bin/env ruby
# frozen_string_literal: true

def find_devbox_dir
  dir = Dir.pwd
  loop do
    devbox = File.join(dir, ".devbox")
    return devbox if File.directory?(devbox) && File.exist?(File.join(devbox, "docker-compose.yml"))

    parent = File.dirname(dir)
    break if parent == dir

    dir = parent
  end
  nil
end

DEVBOX_DIR = find_devbox_dir
unless DEVBOX_DIR
  abort "Error: No .devbox directory found in current or parent directories"
end

COMPOSE_FILE = File.join(DEVBOX_DIR, "docker-compose.yml")

def compose(*args)
  system("docker", "compose", "-f", COMPOSE_FILE, *args)
end

command = ARGV[0]

case command
when "up"
  compose("up", "-d", "--build", "--remove-orphans")
when "down"
  compose("down", "--remove-orphans")
when "shell"
  compose("exec", "web", "sh")
when "logs"
  compose("logs", "-f")
when "run"
  abort "Usage: dev run <command>" if ARGV.length < 2
  compose("exec", "web", *ARGV[1..])
else
  puts "Usage: dev {up|down|shell|logs|run <command>}"
  exit 1
end
